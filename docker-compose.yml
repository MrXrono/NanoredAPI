services:
  nanored-api:
    build: .
    container_name: nanored-api
    hostname: nanored-api
    restart: always
    environment:
      - DATABASE_URL=postgresql+asyncpg://nanored:nanored_secret@nanored-db:5432/nanored_api
      - REDIS_URL=redis://nanored-redis:6379/0
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production-nanored-secret-key-2026}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-nanored_admin_2026}
      - TELEGRAM_MESSAGE_BOT_TOKEN=${TELEGRAM_MESSAGE_BOT_TOKEN:-}
      - TELEGRAM_SUPPORT_GROUP_ID=${TELEGRAM_SUPPORT_GROUP_ID:-0}
      - TELEGRAM_SUPPORT_DATA_FILE=${TELEGRAM_SUPPORT_DATA_FILE:-/app/data/data.json}
      - TELEGRAM_WEBHOOK_URL=${TELEGRAM_WEBHOOK_URL:-}
      - TELEGRAM_WEBHOOK_SECRET=${TELEGRAM_WEBHOOK_SECRET:-}
    volumes:
      - ./data:/app/data
    depends_on:
      nanored-db:
        condition: service_healthy
      nanored-redis:
        condition: service_started
    networks:
      - nanored-internal
      - remnawave-network

  nanored-db:
    image: postgres:16-alpine
    container_name: nanored-db
    hostname: nanored-db
    restart: always
    environment:
      POSTGRES_DB: nanored_api
      POSTGRES_USER: nanored
      POSTGRES_PASSWORD: nanored_secret
    volumes:
      - nanored-pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nanored -d nanored_api"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - nanored-internal

  nanored-redis:
    image: redis:7-alpine
    container_name: nanored-redis
    hostname: nanored-redis
    restart: always
    command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - nanored-redis-data:/data
    networks:
      - nanored-internal

volumes:
  nanored-pgdata:
  nanored-redis-data:

networks:
  nanored-internal:
    driver: bridge
  remnawave-network:
    external: true
