services:
  nanored-api:
    build: .
    container_name: nanored-api
    hostname: nanored-api
    restart: always
    cpus: "0.50"
    environment:
      - DATABASE_URL=postgresql+asyncpg://nanored:nanored_secret@nanored-db:5432/nanored_api
      - REDIS_URL=redis://nanored-redis:6379/0
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production-nanored-secret-key-2026}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-nanored_admin_2026}
      - TELEGRAM_MESSAGE_BOT_TOKEN=${TELEGRAM_MESSAGE_BOT_TOKEN:-}
      - TELEGRAM_SUPPORT_GROUP_ID=${TELEGRAM_SUPPORT_GROUP_ID:-0}
      - TELEGRAM_SUPPORT_DATA_FILE=${TELEGRAM_SUPPORT_DATA_FILE:-/app/data/data.json}
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL:-}
      - TELEGRAM_WEBHOOK_URL=${TELEGRAM_WEBHOOK_URL:-}
      - TELEGRAM_WEBHOOK_SECRET=${TELEGRAM_WEBHOOK_SECRET:-}
      - TELEGRAM_WEBHOOK_DROP_PENDING_UPDATES=${TELEGRAM_WEBHOOK_DROP_PENDING_UPDATES:-0}
      - REMNAWAVE_LOG_INGEST_TOKEN=${REMNAWAVE_LOG_INGEST_TOKEN:-}
      - ADULT_SYNC_HTTP_MAX_CONCURRENCY=${ADULT_SYNC_HTTP_MAX_CONCURRENCY:-1}
      - DB_POOL_SIZE=${DB_POOL_SIZE:-3}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW:-1}
      - DB_POOL_TIMEOUT_SECONDS=${DB_POOL_TIMEOUT_SECONDS:-30}
      - DB_POOL_RECYCLE_SECONDS=${DB_POOL_RECYCLE_SECONDS:-1800}
      - DB_POOL_PRE_PING=${DB_POOL_PRE_PING:-1}
      - DB_COMMAND_TIMEOUT_SECONDS=${DB_COMMAND_TIMEOUT_SECONDS:-60}
      - DB_STATEMENT_TIMEOUT_MS=${DB_STATEMENT_TIMEOUT_MS:-30000}
      - DB_LOCK_TIMEOUT_MS=${DB_LOCK_TIMEOUT_MS:-5000}
      - DB_IDLE_IN_TX_TIMEOUT_MS=${DB_IDLE_IN_TX_TIMEOUT_MS:-60000}
      - REDIS_MAX_CONNECTIONS=${REDIS_MAX_CONNECTIONS:-20}
      - LOG_BUFFER_MAXLEN=${LOG_BUFFER_MAXLEN:-1000}
      - REQUEST_LOG_MAX_BODY_BYTES=${REQUEST_LOG_MAX_BODY_BYTES:-4096}
      - BG_SESSION_CLEANUP_INTERVAL_SECONDS=${BG_SESSION_CLEANUP_INTERVAL_SECONDS:-300}
      - BG_SESSION_CLEANUP_BATCH_SIZE=${BG_SESSION_CLEANUP_BATCH_SIZE:-1000}
      - ADULT_RECHECK_BATCH_LIMIT=${ADULT_RECHECK_BATCH_LIMIT:-1000}
      - ADULT_RECHECK_MAX_BATCHES_PER_LOOP=${ADULT_RECHECK_MAX_BATCHES_PER_LOOP:-2}
      - ADULT_RECHECK_LOOP_SLEEP_SECONDS=${ADULT_RECHECK_LOOP_SLEEP_SECONDS:-30}
      - ADULT_MARK_RECHECK_CHUNK_SIZE=${ADULT_MARK_RECHECK_CHUNK_SIZE:-5000}
      - ADULT_SYNC_TXT_DB_CHUNK_SIZE=${ADULT_SYNC_TXT_DB_CHUNK_SIZE:-5000}
      - ADULT_SYNC_TXT_DB_COMMIT_EVERY=${ADULT_SYNC_TXT_DB_COMMIT_EVERY:-10}
      - ADULT_SYNC_TXT_COPY_ENABLED=${ADULT_SYNC_TXT_COPY_ENABLED:-1}
      - ADULT_SYNC_TXT_MERGE_CHUNK_SIZE=${ADULT_SYNC_TXT_MERGE_CHUNK_SIZE:-50000}
      - ADULT_SYNC_DB_RETRY_MAX_ATTEMPTS=${ADULT_SYNC_DB_RETRY_MAX_ATTEMPTS:-4}
      - ADULT_SYNC_DB_RETRY_BASE_SLEEP_MS=${ADULT_SYNC_DB_RETRY_BASE_SLEEP_MS:-100}
      - REMNAWAVE_LOGS_SUMMARY_DAYS=${REMNAWAVE_LOGS_SUMMARY_DAYS:-7}
      - REMNAWAVE_INGEST_RECLAIM_IDLE_MS=${REMNAWAVE_INGEST_RECLAIM_IDLE_MS:-60000}
      - REMNAWAVE_INGEST_RECLAIM_COUNT=${REMNAWAVE_INGEST_RECLAIM_COUNT:-50}
      - ADULT_MANUAL_SYNC_STREAM=${ADULT_MANUAL_SYNC_STREAM:-stream:adult:manual:sync}
      - ADULT_MANUAL_SYNC_GROUP=${ADULT_MANUAL_SYNC_GROUP:-adult_manual_sync}
      - ADULT_MANUAL_SYNC_CONSUMER=${ADULT_MANUAL_SYNC_CONSUMER:-worker-sync-1}
      - ADULT_MANUAL_TXT_STREAM=${ADULT_MANUAL_TXT_STREAM:-stream:adult:manual:txt}
      - ADULT_MANUAL_TXT_GROUP=${ADULT_MANUAL_TXT_GROUP:-adult_manual_txt}
      - ADULT_MANUAL_TXT_CONSUMER=${ADULT_MANUAL_TXT_CONSUMER:-worker-txtdb-1}
      - ADULT_MANUAL_TASK_READ_COUNT=${ADULT_MANUAL_TASK_READ_COUNT:-5}
      - ADULT_MANUAL_TASK_STREAM_MAXLEN=${ADULT_MANUAL_TASK_STREAM_MAXLEN:-1000}
      - ADULT_MANUAL_TASK_RECLAIM_IDLE_MS=${ADULT_MANUAL_TASK_RECLAIM_IDLE_MS:-60000}
      - ADULT_MANUAL_TASK_RECLAIM_COUNT=${ADULT_MANUAL_TASK_RECLAIM_COUNT:-10}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_DIR=${LOG_DIR:-/app/data/logs}
      - LOG_FILE_NAME=${LOG_FILE_NAME:-nanored-api.log}
      - LOG_FILE_ROTATION_WHEN=${LOG_FILE_ROTATION_WHEN:-midnight}
      - LOG_FILE_ROTATION_INTERVAL=${LOG_FILE_ROTATION_INTERVAL:-1}
      - LOG_FILE_RETENTION_DAYS=${LOG_FILE_RETENTION_DAYS:-7}
      - FUNCTION_CALL_LOGGING_ENABLED=${FUNCTION_CALL_LOGGING_ENABLED:-0}
      - FUNCTION_CALL_LOG_EXCLUDE_MODULES=${FUNCTION_CALL_LOG_EXCLUDE_MODULES:-app.core.logging_setup}
      - RUN_ADULT_SYNC_WORKER=${RUN_ADULT_SYNC_WORKER:-0}
      - RUN_TXT_DB_WORKER=${RUN_TXT_DB_WORKER:-0}
      - RUN_SESSION_CLEANUP_WORKER=${RUN_SESSION_CLEANUP_WORKER:-0}
      - RUN_DB_MAINTENANCE_WORKER=${RUN_DB_MAINTENANCE_WORKER:-0}
    volumes:
      - ./data:/app/data
    depends_on:
      nanored-db:
        condition: service_healthy
      nanored-redis:
        condition: service_started
    networks:
      - nanored-internal
      - remnawave-network

  nanored-worker-sync:
    build: .
    container_name: nanored-worker-sync
    hostname: nanored-worker-sync
    restart: always
    cpus: "0.50"
    command: ["python", "-m", "app.worker_runner"]
    environment:
      - WORKER_ROLE=adult_sync
      - RUN_ADULT_SYNC_WORKER=1
      - RUN_TXT_DB_WORKER=0
      - RUN_SESSION_CLEANUP_WORKER=0
      - RUN_DB_MAINTENANCE_WORKER=0
      - DATABASE_URL=postgresql+asyncpg://nanored:nanored_secret@nanored-db:5432/nanored_api
      - REDIS_URL=redis://nanored-redis:6379/0
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production-nanored-secret-key-2026}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-nanored_admin_2026}
      - REMNAWAVE_LOG_INGEST_TOKEN=${REMNAWAVE_LOG_INGEST_TOKEN:-}
      - ADULT_SYNC_HTTP_MAX_CONCURRENCY=${ADULT_SYNC_HTTP_MAX_CONCURRENCY:-1}
      - DB_POOL_SIZE=${DB_POOL_SIZE:-3}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW:-1}
      - DB_POOL_TIMEOUT_SECONDS=${DB_POOL_TIMEOUT_SECONDS:-30}
      - DB_POOL_RECYCLE_SECONDS=${DB_POOL_RECYCLE_SECONDS:-1800}
      - DB_POOL_PRE_PING=${DB_POOL_PRE_PING:-1}
      - DB_COMMAND_TIMEOUT_SECONDS=${DB_COMMAND_TIMEOUT_SECONDS:-60}
      - DB_STATEMENT_TIMEOUT_MS=${DB_STATEMENT_TIMEOUT_MS:-30000}
      - DB_LOCK_TIMEOUT_MS=${DB_LOCK_TIMEOUT_MS:-5000}
      - DB_IDLE_IN_TX_TIMEOUT_MS=${DB_IDLE_IN_TX_TIMEOUT_MS:-60000}
      - REDIS_MAX_CONNECTIONS=${REDIS_MAX_CONNECTIONS:-20}
      - ADULT_RECHECK_BATCH_LIMIT=${ADULT_RECHECK_BATCH_LIMIT:-1000}
      - ADULT_RECHECK_MAX_BATCHES_PER_LOOP=${ADULT_RECHECK_MAX_BATCHES_PER_LOOP:-2}
      - ADULT_RECHECK_LOOP_SLEEP_SECONDS=${ADULT_RECHECK_LOOP_SLEEP_SECONDS:-30}
      - ADULT_MARK_RECHECK_CHUNK_SIZE=${ADULT_MARK_RECHECK_CHUNK_SIZE:-5000}
      - ADULT_SYNC_TXT_DB_CHUNK_SIZE=${ADULT_SYNC_TXT_DB_CHUNK_SIZE:-5000}
      - ADULT_SYNC_TXT_DB_COMMIT_EVERY=${ADULT_SYNC_TXT_DB_COMMIT_EVERY:-10}
      - ADULT_SYNC_TXT_COPY_ENABLED=${ADULT_SYNC_TXT_COPY_ENABLED:-1}
      - ADULT_SYNC_TXT_MERGE_CHUNK_SIZE=${ADULT_SYNC_TXT_MERGE_CHUNK_SIZE:-50000}
      - ADULT_SYNC_DB_RETRY_MAX_ATTEMPTS=${ADULT_SYNC_DB_RETRY_MAX_ATTEMPTS:-4}
      - ADULT_SYNC_DB_RETRY_BASE_SLEEP_MS=${ADULT_SYNC_DB_RETRY_BASE_SLEEP_MS:-100}
      - ADULT_MANUAL_SYNC_STREAM=${ADULT_MANUAL_SYNC_STREAM:-stream:adult:manual:sync}
      - ADULT_MANUAL_SYNC_GROUP=${ADULT_MANUAL_SYNC_GROUP:-adult_manual_sync}
      - ADULT_MANUAL_SYNC_CONSUMER=${ADULT_MANUAL_SYNC_CONSUMER:-worker-sync-1}
      - ADULT_MANUAL_TASK_READ_COUNT=${ADULT_MANUAL_TASK_READ_COUNT:-5}
      - ADULT_MANUAL_TASK_STREAM_MAXLEN=${ADULT_MANUAL_TASK_STREAM_MAXLEN:-1000}
      - ADULT_MANUAL_TASK_RECLAIM_IDLE_MS=${ADULT_MANUAL_TASK_RECLAIM_IDLE_MS:-60000}
      - ADULT_MANUAL_TASK_RECLAIM_COUNT=${ADULT_MANUAL_TASK_RECLAIM_COUNT:-10}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_DIR=${LOG_DIR:-/app/data/logs}
      - LOG_FILE_NAME=${LOG_FILE_NAME:-nanored-api.log}
      - LOG_ERROR_FILE_NAME=${LOG_ERROR_FILE_NAME:-nanored-api-error.log}
      - LOG_FILE_ROTATION_WHEN=${LOG_FILE_ROTATION_WHEN:-midnight}
      - LOG_FILE_ROTATION_INTERVAL=${LOG_FILE_ROTATION_INTERVAL:-1}
      - LOG_FILE_RETENTION_DAYS=${LOG_FILE_RETENTION_DAYS:-7}
      - FUNCTION_CALL_LOGGING_ENABLED=${FUNCTION_CALL_LOGGING_ENABLED:-0}
      - FUNCTION_CALL_LOG_EXCLUDE_MODULES=${FUNCTION_CALL_LOG_EXCLUDE_MODULES:-app.core.logging_setup}
      - DB_MAINTENANCE_ENABLED=${DB_MAINTENANCE_ENABLED:-1}
      - DB_MAINTENANCE_ANALYZE_INTERVAL_SECONDS=${DB_MAINTENANCE_ANALYZE_INTERVAL_SECONDS:-1800}
      - DB_MAINTENANCE_INDEX_SETUP_ON_STARTUP=${DB_MAINTENANCE_INDEX_SETUP_ON_STARTUP:-1}
    volumes:
      - ./data:/app/data
    depends_on:
      nanored-db:
        condition: service_healthy
      nanored-redis:
        condition: service_started
    networks:
      - nanored-internal
      - remnawave-network

  nanored-worker-txtdb:
    build: .
    container_name: nanored-worker-txtdb
    hostname: nanored-worker-txtdb
    restart: always
    cpus: "0.50"
    command: ["python", "-m", "app.worker_runner"]
    environment:
      - WORKER_ROLE=txt_db
      - RUN_ADULT_SYNC_WORKER=0
      - RUN_TXT_DB_WORKER=1
      - RUN_SESSION_CLEANUP_WORKER=0
      - RUN_DB_MAINTENANCE_WORKER=0
      - DATABASE_URL=postgresql+asyncpg://nanored:nanored_secret@nanored-db:5432/nanored_api
      - REDIS_URL=redis://nanored-redis:6379/0
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production-nanored-secret-key-2026}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-nanored_admin_2026}
      - REMNAWAVE_LOG_INGEST_TOKEN=${REMNAWAVE_LOG_INGEST_TOKEN:-}
      - REMNAWAVE_INGEST_QUEUE_ENABLED=${REMNAWAVE_INGEST_QUEUE_ENABLED:-1}
      - REMNAWAVE_INGEST_STREAM=${REMNAWAVE_INGEST_STREAM:-stream:remnawave:ingest}
      - REMNAWAVE_INGEST_GROUP=${REMNAWAVE_INGEST_GROUP:-remnawave_ingest}
      - REMNAWAVE_INGEST_CONSUMER=${REMNAWAVE_INGEST_CONSUMER:-worker-txtdb-1}
      - REMNAWAVE_INGEST_READ_COUNT=${REMNAWAVE_INGEST_READ_COUNT:-10}
      - REMNAWAVE_INGEST_STREAM_MAXLEN=${REMNAWAVE_INGEST_STREAM_MAXLEN:-50000}
      - REMNAWAVE_INGEST_MAX_RETRIES=${REMNAWAVE_INGEST_MAX_RETRIES:-3}
      - REMNAWAVE_INGEST_DEAD_STREAM=${REMNAWAVE_INGEST_DEAD_STREAM:-stream:remnawave:ingest:dead}
      - REMNAWAVE_INGEST_DEAD_MAXLEN=${REMNAWAVE_INGEST_DEAD_MAXLEN:-10000}
      - REMNAWAVE_INGEST_RECLAIM_IDLE_MS=${REMNAWAVE_INGEST_RECLAIM_IDLE_MS:-60000}
      - REMNAWAVE_INGEST_RECLAIM_COUNT=${REMNAWAVE_INGEST_RECLAIM_COUNT:-50}
      - ADULT_MANUAL_TXT_STREAM=${ADULT_MANUAL_TXT_STREAM:-stream:adult:manual:txt}
      - ADULT_MANUAL_TXT_GROUP=${ADULT_MANUAL_TXT_GROUP:-adult_manual_txt}
      - ADULT_MANUAL_TXT_CONSUMER=${ADULT_MANUAL_TXT_CONSUMER:-worker-txtdb-1}
      - ADULT_MANUAL_TASK_READ_COUNT=${ADULT_MANUAL_TASK_READ_COUNT:-5}
      - ADULT_MANUAL_TASK_STREAM_MAXLEN=${ADULT_MANUAL_TASK_STREAM_MAXLEN:-1000}
      - ADULT_MANUAL_TASK_RECLAIM_IDLE_MS=${ADULT_MANUAL_TASK_RECLAIM_IDLE_MS:-60000}
      - ADULT_MANUAL_TASK_RECLAIM_COUNT=${ADULT_MANUAL_TASK_RECLAIM_COUNT:-10}
      - DB_POOL_SIZE=${DB_POOL_SIZE:-3}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW:-1}
      - DB_POOL_TIMEOUT_SECONDS=${DB_POOL_TIMEOUT_SECONDS:-30}
      - DB_POOL_RECYCLE_SECONDS=${DB_POOL_RECYCLE_SECONDS:-1800}
      - DB_POOL_PRE_PING=${DB_POOL_PRE_PING:-1}
      - DB_COMMAND_TIMEOUT_SECONDS=${DB_COMMAND_TIMEOUT_SECONDS:-60}
      - DB_STATEMENT_TIMEOUT_MS=${DB_STATEMENT_TIMEOUT_MS:-30000}
      - DB_LOCK_TIMEOUT_MS=${DB_LOCK_TIMEOUT_MS:-5000}
      - DB_IDLE_IN_TX_TIMEOUT_MS=${DB_IDLE_IN_TX_TIMEOUT_MS:-60000}
      - REDIS_MAX_CONNECTIONS=${REDIS_MAX_CONNECTIONS:-20}
      - REMNAWAVE_INGEST_COPY_ENABLED=${REMNAWAVE_INGEST_COPY_ENABLED:-1}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_DIR=${LOG_DIR:-/app/data/logs}
      - LOG_FILE_NAME=${LOG_FILE_NAME:-nanored-api.log}
      - LOG_ERROR_FILE_NAME=${LOG_ERROR_FILE_NAME:-nanored-api-error.log}
      - LOG_FILE_ROTATION_WHEN=${LOG_FILE_ROTATION_WHEN:-midnight}
      - LOG_FILE_ROTATION_INTERVAL=${LOG_FILE_ROTATION_INTERVAL:-1}
      - LOG_FILE_RETENTION_DAYS=${LOG_FILE_RETENTION_DAYS:-7}
      - FUNCTION_CALL_LOGGING_ENABLED=${FUNCTION_CALL_LOGGING_ENABLED:-0}
      - FUNCTION_CALL_LOG_EXCLUDE_MODULES=${FUNCTION_CALL_LOG_EXCLUDE_MODULES:-app.core.logging_setup}
      - DB_MAINTENANCE_ENABLED=${DB_MAINTENANCE_ENABLED:-1}
      - DB_MAINTENANCE_ANALYZE_INTERVAL_SECONDS=${DB_MAINTENANCE_ANALYZE_INTERVAL_SECONDS:-1800}
      - DB_MAINTENANCE_INDEX_SETUP_ON_STARTUP=${DB_MAINTENANCE_INDEX_SETUP_ON_STARTUP:-1}
    volumes:
      - ./data:/app/data
    depends_on:
      nanored-db:
        condition: service_healthy
      nanored-redis:
        condition: service_started
    networks:
      - nanored-internal
      - remnawave-network

  nanored-db:
    image: postgres:16-alpine
    container_name: nanored-db
    hostname: nanored-db
    restart: always
    cpus: "0.50"
    environment:
      POSTGRES_DB: nanored_api
      POSTGRES_USER: nanored
      POSTGRES_PASSWORD: nanored_secret
    volumes:
      - nanored-pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nanored -d nanored_api"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - nanored-internal

  nanored-redis:
    image: redis:7-alpine
    container_name: nanored-redis
    hostname: nanored-redis
    restart: always
    cpus: "0.50"
    command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - nanored-redis-data:/data
    networks:
      - nanored-internal

volumes:
  nanored-pgdata:
  nanored-redis-data:

networks:
  nanored-internal:
    driver: bridge
  remnawave-network:
    external: true
